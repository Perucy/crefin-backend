// crefin database schema
// ============================================================================
// PRISMA CONFIGURATION
// ============================================================================

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql" //using postgresql
}

// ============================================================================
// USERS (Authentication + Profile)
// ============================================================================

model User {
    id        String     @id @default(uuid())
    email     String     @unique
    password  String

    //profile info
    name          String
    phone         String?
    profilePicture String?
    profession    String?
    skills        String[]
    hourlyRate    Decimal?  @db.Decimal(10, 2)

    //account status
    isEmailVerified          Boolean @default(false) //email verified?
    isPremium           Boolean @default(false) //premium account?
    premiumExpiry       DateTime?

    emailVerificationToken   String?
    emailVerificationExpires DateTime?
    passwordResetToken       String?
    passwordResetExpires     DateTime?

    //Timestamps
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt
    lastLoginAt     DateTime?

    //relations (one user has many.....)
    refreshTokens     RefreshToken[]
    payments          Payment[]
    incomeLogs        IncomeLog[]
    expenseLogs       ExpenseLog[]
    alerts            Alert[]
    premiumPayments   PremiumPayment[]
    goals             Goal[]
    clients           Client[]
    invoices         Invoice[]

    @@index([email])
    @@map("users")
}

// ============================================================================
// REFRESH TOKENS (JWT Sessions)
// ============================================================================
model RefreshToken {
    id String @id @default(uuid())
    token String @unique
    userId String                   //token's owner
    expiresAt DateTime          //expiry date
    createdAt DateTime @default(now())

    //relation 
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@map("refresh_tokens")
}

// ============================================================================
// MARKET RATES (Cached from Upwork/Fiverr)
// ============================================================================
model MarketRate {
    id String @id @default(uuid())
    skill String
    category String?

    //rate data
    rateMin Decimal @db.Decimal(10, 2)
    rateMax Decimal @db.Decimal(10, 2)
    rateAvg Decimal @db.Decimal(10, 2)
    currency String @default("USD") 

    //Metadata
    source String //e.g upwork, fiverr etc
    region String @default("US") //us, uk, eu
    sampleSize Int @default(0) //number of jobs analyzed
    confidence Decimal @db.Decimal(3, 2) @default(0.00) //0.0 - 1.0 reliability score

    //Timestamps
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt  //updated every 20 min by a background job

    @@unique([skill, region, source]) //one rate per skill+region+source combo
    @@index([skill, region])
    @@map("market_rates")
}

// ============================================================================
// PAYMENTS (Sent/Received Money)
// ============================================================================
enum PaymentDirection {
    SENT //user paid someone
    RECEIVED //User received money
}

model Payment {
    id String @id @default(uuid())
    userId String  //who's logging this payment

    //payment details
    amount Decimal @db.Decimal(10, 2)
    direction PaymentDirection //sent or recieved
    counterpartyName String? //client or freelancer name
    counterPartyEmail String? 
    status String //pending, completed. failed

    //escrow 
    escrowEnabled Boolean @default(false)
    escrowReleasedAt DateTime?

    //External integration
    paymentMethod String? //venmo, paypal, stripe
    externalTxId String? //external transaction id

    // Links (ONE payment can link to ONE income OR expense)
    incomeLogId String?
    expenseLogId String?
    

    //metadata
    memo String? //optional note
    feeAmount Decimal? @db.Decimal(10, 2)

    //timestamps
    paymentDate DateTime @default(now())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt


    //Relation
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    incomeLog IncomeLog? @relation(fields: [incomeLogId], references: [id])
    expenseLog ExpenseLog? @relation(fields: [expenseLogId], references: [id])

    @@index([userId,status])
    @@index([paymentDate])
    @@map("payments")
}

// ============================================================================
// INCOME LOGS (Gigs/Projects Completed)
// ============================================================================

model IncomeLog {
    id          String   @id @default(uuid())
    userId      String
    
    // Income details
    amount      Decimal  @db.Decimal(10, 2)
    projectName String?
    clientName  String?
    clientId    String?
    skill       String?                     // What skill was this for?
    hours       Decimal? @db.Decimal(5, 2)  // Hours worked
    ratePerHour Decimal? @db.Decimal(10, 2) // Effective hourly rate

    // Link back to payment (if exists)
    payments Payment[]  // One income can have multiple payments (installments)
  
    // Metadata
    source      String   @default("manual") // "manual", "voice"
    notes       String?
    
    // Timestamps
    loggedAt    DateTime @default(now())
    createdAt   DateTime @default(now())
    
    // Relation
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
    invoice Invoice?

    @@index([userId, loggedAt])
    @@map("income_logs")
}
// ============================================================================
// EXPENSE LOGS (Business Expenses)
// ============================================================================

model ExpenseLog {
    id           String   @id @default(uuid())
    userId       String
    
    // Expense details
    amount       Decimal  @db.Decimal(10, 2)
    category     String   // "software", "equipment", "marketing", "travel"
    description  String
    isDeductible Boolean  @default(true)    // Tax deductible?

    // Link back to payment (if exists)
    payments Payment[]  // One expense can have multiple payments
    
    // Supporting docs
    receiptUrl   String?
    
    // Timestamps
    loggedAt     DateTime @default(now())
    createdAt    DateTime @default(now())
    
    // Relation
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId, loggedAt])
    @@map("expense_logs")
}

// ============================================================================
// ALERTS (AI-Generated Insights)
// ============================================================================
model Alert {
    id          String   @id @default(uuid())
    userId      String
    
    // Alert details
    type        String   // "underpriced", "tax_due", "expense_opportunity"
    severity    String   // "low", "medium", "high"
    title       String
    description String
    actionUrl   String?
    
    // Status
    dismissed   Boolean  @default(false)
    dismissedAt DateTime?
    
    // Timestamps
    createdAt   DateTime @default(now())
    
    // Relation
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId, dismissed])
    @@map("alerts")
}

// ============================================================================
// PREMIUM PAYMENTS (Subscription History)
// ============================================================================
model PremiumPayment {
    id                 String   @id @default(uuid())
    userId             String
    
    // Payment details
    amount             Decimal  @db.Decimal(10, 2)  // $4.99
    stripePaymentId    String?  @unique
    status             String   // "succeeded", "failed", "refunded"
    
    // Billing period
    billingPeriodStart DateTime
    billingPeriodEnd   DateTime
    
    // Timestamps
    createdAt          DateTime @default(now())
    
    // Relation
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId, status])
    @@map("premium_payments")
}

// ============================================================================
// GOALS (Financial Goals)
// ============================================================================
model Goal {
    id            String   @id @default(uuid())
    userId        String
    
    // Goal details
    title         String
    category      String   // "travel", "real-estate", "education", etc.
    targetAmount  Decimal  @db.Decimal(10, 2)
    currentAmount Decimal  @db.Decimal(10, 2) @default(0)
    deadline      DateTime?
    description   String?
    
    // Timestamps
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
    
    // Relation
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId])
    @@map("goals")
}

// ============================================================================
// CLIENTS (Freelance Clients)
// ============================================================================
model Client {
    id        String   @id @default(uuid())
    userId    String
    
    // Client details
    name      String
    email     String?
    phone     String?
    company   String?
    address   String?
    notes     String?
    
    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    // Relations
    user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    incomeLogs IncomeLog[]  // One client can have many income entries
    invoices   Invoice[]    // One client can have many invoices    

    @@index([userId])
    @@map("clients")
}

// =====================================================================================
// INVOICE
// =====================================================================================
model Invoice {
    id            String   @id @default(uuid())
    userId        String
    clientId      String
    
    // Invoice identification
    invoiceNumber String   @unique
    
    // Invoice details
    amount        Decimal  @db.Decimal(10, 2)
    description   String
    items         Json?
    
    // Status tracking
    status        String   @default("draft")
    
    // Dates
    issueDate     DateTime @default(now())
    dueDate       DateTime
    paidDate      DateTime?
    
    // Payment tracking
    incomeLogId   String?  @unique
    
    // Additional details
    notes         String?
    terms         String?  @default("Payment due within 30 days")
    
    // payment prediction
    predictedPaymentDays   Float?
    predictionConfidence   Float?
    predictedPaymentDate   DateTime?

    // Timestamps
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
    
    // Relations
    user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    client        Client     @relation(fields: [clientId], references: [id], onDelete: Restrict)
    incomeLog     IncomeLog? @relation(fields: [incomeLogId], references: [id])
    
    @@index([userId, status])
    @@index([clientId])
    @@index([invoiceNumber])
    @@map("invoices")
}